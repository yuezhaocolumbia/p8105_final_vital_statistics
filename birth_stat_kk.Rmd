---
title: "birth_stat_kk"
author: "Kangkang Zhang"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(haven)
library(purrr)
```

Three different source of the data: community district, zip code and census tract
```{r}
# community district
file_name = tibble(
  id = list.files("./birth_data/community_district")
)

birth_data = file_name %>%
  mutate(infor = map(str_c("./birth_data/community_district/", id), read_sas)) %>% 
  separate(id, c("name", "year", "del"), sep = c(6, 8)) %>% 
  select(-name, -del) %>% 
  mutate(year = str_c("20", year), year = as.numeric(year))

# import cd code data
cd_code_data = 
  read_csv("./data/New_York_City_Population_By_Community_Districts 16.09.03.csv") %>%
  janitor::clean_names() %>%
  select(borough, cd_number, cd_name) %>% 
  rename(cd = cd_number) %>% 
  mutate(cd = ifelse(borough == "Bronx", cd + 200, cd)) %>% 
  mutate(cd = ifelse(borough == "Brooklyn", cd + 300, cd)) %>% 
  mutate(cd = ifelse(borough == "Manhattan", cd + 100, cd)) %>% 
  mutate(cd = ifelse(borough == "Queens", cd + 400, cd)) %>% 
  mutate(cd = ifelse(borough == "Staten Island", cd + 500, cd)) 

# join two data
birth_data_un = 
  birth_data %>% 
  unnest() %>% 
  left_join(cd_code_data, by = "cd") 
```

```{r}
birth_data_cd %>% 
  unnest() %>% 
  summarise_all(funs(sum(is.na(.)))) %>% View

maternal_age_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot)

maternal_race_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, eth_bl_tot:eth_ap_tot) %>%
  gather(maternal_race, num, eth_bl_tot:eth_ap_tot)

born_demo_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot:nat2tot) %>%
  gather(born_demo, num, nat1tot:nat2tot)
  
maternal_anc_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, ancs1tot:ancs15tot) %>%
  gather(maternal_anc, num, ancs1tot:ancs15tot)

maternal_birth_place_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, bpl1tot:bpl_oth_tot) %>%
  gather(maternal_birth_place, num, bpl1tot:bpl_oth_tot)

parity_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, par1tot:par2tot) %>%
  gather(parity, num, par1tot:par2tot)

marry_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, mar1tot:mar2tot) %>%
  gather(marry_status, num, mar1tot:mar2tot)

infant_sex_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot)

infant_sex_data = birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot)

birth_weight_data =  birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, bwt1tot:bwt9tot) %>%
  gather(birth_weight, num, bwt1tot:bwt9tot)

apg_count_data =  birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, apg1tot:apg5tot) %>%
  gather(apg_count, num, apg1tot:apg5tot)

birth_place_data =  birth_data_cd_un %>% 
  select(year, cd, cd_name, borough, birthtot, pob1tot:pob5tot) %>%
  gather(birth_place, num, pob1tot:pob5tot)

bwt_age_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_a")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("bwt")) %>% 
  gather(bwt_age, num, bwt1ctot_a1:bwt2ctot_a4)

bwt_nat_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("bwt")) %>% 
  gather(bwt_nat, num, bwt1ctot_n1:bwt2ctot_n2)

ga_nat_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("ga")) %>% 
  gather(ga_nat, num, ga1ctot_n1:ga2ctot_n2)

plur_age_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("tot_a")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("plu")) %>% 
  gather(plur_age, num, plur1tot_a1:plur2tot_a4)

plur_nat_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("tot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("plu")) %>% 
  gather(plur_nat, num, plur1tot_n1:plur2tot_n2)

sex_nat_data =  birth_data_cd_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("tot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("sex")) %>% 
  gather(sex_nat, num, sex1tot_n1:sex2tot_n2)
```

```{r}
birth_data_un %>% 
  select(year, cd, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(delta))

  
birth_data_un %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) %>% View
  filter(percent > 0.2) 
```

**Individual Variables**

age, race, nativity, parity, maternal marital status, infant sex, infant birthweight, infant gestational age

```{r}
# data for maternal age
maternal_age_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot) %>% 
  group_by(year, borough, maternal_age) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = maternal_age, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(delta))

birth_data_un %>%
  select(starts_with("age")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

maternal_age_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot) %>%
  arrange(cd, maternal_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
  
```

  
```{r}
# data for maternal race
maternal_race_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, eth_bl_tot:eth_ap_tot) %>%
  gather(maternal_race, num, eth_bl_tot:eth_ap_tot) %>% 
  group_by(year, borough, maternal_race) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = maternal_race, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, eth_bl_tot:eth_ap_tot) %>%
  gather(maternal_race, num, eth_bl_tot:eth_ap_tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("eth_")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

ma_race_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, eth_bl_tot:eth_ap_tot) %>%
  gather(maternal_race, num, eth_bl_tot:eth_ap_tot) %>%
  arrange(cd, maternal_race, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```

```{r}
# data for maternal nativity
born_demo_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot:nat2tot) %>%
  gather(born_demo, num, nat1tot:nat2tot) %>% 
  group_by(year, borough, born_demo) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = born_demo, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, nat1tot:nat2tot) %>%
  gather(born_demo, num, nat1tot:nat2tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("nat")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

#no missing data
ma_nat_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot:nat2tot) %>%
  gather(ma_nat, num, nat1tot:nat2tot) %>%
  arrange(cd, ma_nat, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```


```{r}
# data for parity
parity_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, par1tot:par2tot) %>%
  gather(parity, num, par1tot:par2tot) %>% 
  group_by(year, borough, parity) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = parity, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, par1tot:par2tot) %>%
  gather(parity, num, par1tot:par2tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("par")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

#no missing data
parity_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, par1tot:par2tot) %>%
  gather(parity, num, par1tot:par2tot) %>%
  arrange(cd, parity, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
``` 


```{r}
# data for maternal marital status 
marry_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, mar1tot:mar2tot) %>%
  gather(marry_status, num, mar1tot:mar2tot) %>% 
  group_by(year, borough, marry_status) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = marry_status, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, mar1tot:mar2tot) %>%
  gather(marry_status, num, mar1tot:mar2tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("mar")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

#no missing data
marry_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, mar1tot:mar2tot) %>%
  gather(marry_status, num, mar1tot:mar2tot) %>%
  arrange(cd, marry_status, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```


```{r}
# data for infant sex
infant_sex_data = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot) %>% 
  group_by(year, borough, infant_sex) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = infant_sex, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("sex")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

#no missing data
infant_sex_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot) %>%
  arrange(cd, infant_sex, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```

```{r}
# data for infant birthweight
birth_weight_data =  
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, bwt1tot:bwt9tot) %>%
  gather(birth_weight, num, bwt1tot:bwt9tot) %>% 
  group_by(year, borough, birth_weight) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = birth_weight, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, bwt1tot:bwt9tot) %>%
  gather(bwt, num, bwt1tot:bwt9tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("bwt")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 


birth_weight_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, bwt1tot:bwt9tot) %>%
  gather(birth_weight, num, bwt1tot:bwt9tot) %>%
  arrange(cd, birth_weight, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```


```{r}
# data for infant gestational age
birth_ges = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, ga1tot:ga5tot) %>% 
  gather(key = gestational_age, value = num, ga1tot:ga5tot)  %>% 
  group_by(year, borough, gestational_age) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = gestational_age, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, ga1tot:ga5tot) %>%
  gather(bwt, num, ga1tot:ga5tot) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("ga")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

birth_ges_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, ga1tot:ga5tot) %>%
  gather(birth_ges, num, ga1tot:ga5tot) %>%
  arrange(cd, birth_ges, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```






**Crossed Variables**
infant birthweight and maternal age, infant sex and maternal nativity, maternal nativity and maternal age, gestational and maternal age, infant sex and maternal age

```{r}
# data for infant birthweight and maternal age
bwt_age_data =  
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_a")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("bwt")) %>% 
  gather(bwt_age, num, bwt1ctot_a1:bwt2ctot_a4) %>% 
  group_by(year, borough, bwt_age) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = bwt_age, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, contains("ctot_a")) %>%
  select(year, cd, birthtot, starts_with("bwt")) %>%
  gather(bwt, num, bwt1ctot_a1:bwt2ctot_a4) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(starts_with("bwt")) %>% 
  select(contains("ctot_a")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

bwt_age_nomiss_data =
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_a")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("bwt")) %>% 
  gather(bwt_age, num, bwt1ctot_a1:bwt2ctot_a4) %>%
  arrange(cd, bwt_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```



```{r}
# data for infant sex and maternal nativity
sex_nat_data =  
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("tot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("sex")) %>% 
  gather(sex_nat, num, sex1tot_n1:sex2tot_n2) %>% 
  group_by(year, borough, sex_nat) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = sex_nat, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, contains("tot_n")) %>%
  select(year, cd, birthtot, starts_with("sex")) %>%
  gather(sex, num, sex1tot_n1:sex2tot_n2) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(contains("tot_n")) %>% 
  select(starts_with("sex")) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

#no missing data
sex_nat_nomiss_data =
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("tot_n")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("sex")) %>% 
  gather(sex_nat, num, sex1tot_n1:sex2tot_n2) %>%
  arrange(cd, sex_nat, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```


```{r}
# data for maternal nativity and maternal age
birth_nat_age = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot_a1, nat2tot_a1, nat1tot_a2, nat2tot_a2, nat1tot_a3, nat2tot_a3, nat1tot_a4, nat2tot_a4) %>% 
  gather(key = nativity_age, value = num, nat1tot_a1:nat2tot_a4) %>% 
  group_by(year, borough, nativity_age) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = nativity_age, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, nat1tot_a1, nat2tot_a1, nat1tot_a2, nat2tot_a2, nat1tot_a3, nat2tot_a3, nat1tot_a4, nat2tot_a4) %>%
  gather(nativity_age, num, nat1tot_a1:nat2tot_a4) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(nat1tot_a1, nat2tot_a1, nat1tot_a2, nat2tot_a2, nat1tot_a3, nat2tot_a3, nat1tot_a4, nat2tot_a4) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

birth_nat_age_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot_a1, nat2tot_a1, nat1tot_a2, nat2tot_a2, nat1tot_a3, nat2tot_a3, nat1tot_a4, nat2tot_a4) %>%
  gather(nativity_age, num, nat1tot_a1:nat2tot_a4) %>%
  arrange(cd, nativity_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
  
```


```{r}
# data for infant sex and maternal age
birth_sex_age = 
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot_a1, sex2tot_a1, sex1tot_a2, sex2tot_a2, sex1tot_a3, sex2tot_a3, sex1tot_a4, sex2tot_a4) %>% 
  gather(key = sex_age, value = num, sex1tot_a1:sex2tot_a4) %>% 
  group_by(year, borough, sex_age) %>% 
  summarise(number = sum(num)) %>% 
  spread(key = sex_age, value = number) %>% 
  knitr::kable(digits = 3)

birth_data_un %>% 
  select(year, cd, birthtot, sex1tot_a1, sex2tot_a1, sex1tot_a2, sex2tot_a2, sex1tot_a3, sex2tot_a3, sex1tot_a4, sex2tot_a4) %>%
  gather(sex_age, num, sex1tot_a1:sex2tot_a4) %>% 
  group_by(year, cd, birthtot) %>% 
  summarise(ttl = sum(num, na.rm = TRUE)) %>% 
  mutate(delta = birthtot - ttl, percent = delta/birthtot) %>% 
  arrange(desc(percent))

birth_data_un %>%
  select(sex1tot_a1, sex2tot_a1, sex1tot_a2, sex2tot_a2, sex1tot_a3, sex2tot_a3, sex1tot_a4, sex2tot_a4) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  gather(term, num_na, everything()) %>% 
  mutate(percent = num_na/885) 

birth_sex_age_nomiss_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot_a1, sex2tot_a1, sex1tot_a2, sex2tot_a2, sex1tot_a3, sex2tot_a3, sex1tot_a4, sex2tot_a4) %>%
  gather(sex_age, num, sex1tot_a1:sex2tot_a4) %>%
  arrange(cd, sex_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != "00", lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num))
```

###Plot

plot for age

```{r}
maternal_age_plot_data =
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, age1tot:age9tot) %>%
  gather(maternal_age, num, age1tot:age9tot) %>%
  arrange(cd, maternal_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_age = case_when(
    maternal_age %in% c("age1tot", "age2tot") ~ "< 18",
    maternal_age %in% c("age3tot", "age4tot") ~ "18 - 24",
    maternal_age == "age5tot" ~ "25 - 29",
    maternal_age == "age6tot" ~ "30 - 34",
    maternal_age == "age7tot" ~ "35 - 39",
    TRUE                      ~  "40 +"
  )) %>% 
  group_by(year, borough, new_age) %>% 
  summarise(number = sum(num)) 
  
#useful
#the birth trend in different maternal age in NYC
maternal_age_plot_data %>%
  group_by(year, new_age) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, color = new_age)) +
  geom_point() +
  geom_line() +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      color = "Maternal Age") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_color_viridis(discrete = TRUE)

#useful
#the birth trend in different maternal age in NYC for each boro
maternal_age_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, color = new_age)) +
  geom_point() +
  geom_line() +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      color = "Maternal Age") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_color_viridis(discrete = TRUE) 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
  
```

plot for for maternal nativity
```{r}
ma_nat_plot_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, nat1tot:nat2tot) %>%
  gather(ma_nat, num, nat1tot:nat2tot) %>%
  arrange(cd, ma_nat, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_ma_nat = ifelse(ma_nat == "nat1tot", "US Born", "Foreign Born")) %>% 
  group_by(year, borough, new_ma_nat) %>% 
  summarise(number = sum(num))

#the birth trend in different maternal nativity in NYC
ma_nat_plot_data %>%
  group_by(year, new_ma_nat) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, color = new_ma_nat)) +
  geom_point() +
  geom_line() +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      fill = "Maternal Nativity") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_color_viridis(discrete = TRUE)

#the birth trend in different maternal nativity in NYC for each boro
ma_nat_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, color = new_ma_nat)) +
  geom_point() +
  geom_line() +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      color = "Maternal Nativity") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_color_viridis(discrete = TRUE) 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```


#data for parity

```{r}
parity_plot_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, par1tot:par2tot) %>%
  gather(parity, num, par1tot:par2tot) %>%
  arrange(cd, parity, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_parity = ifelse(parity == "par1tot", "First live birth", "Not first live birth")) %>% 
  group_by(year, borough, new_parity) %>% 
  summarise(number = sum(num)) 

#the birth trend in different Parity in NYC
parity_plot_data %>%
  group_by(year, new_parity) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, fill = new_parity)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      fill = "Parity") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_fill_viridis(discrete = TRUE)

#the birth trend in different maternal nativity in NYC for each boro
parity_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, fill = new_parity)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      fill = "Parity") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "bottom")
```

plot for maternal marital status

```{r}
# data for maternal marital status 
marry_plot_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, mar1tot:mar2tot) %>%
  gather(marry_status, num, mar1tot:mar2tot) %>%
  arrange(cd, marry_status, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_marry_status = ifelse(marry_status == "mar1tot", "Married", "Not Married")) %>% 
  group_by(year, borough, new_marry_status) %>% 
  summarise(number = sum(num))  

#may useful
#the birth trend in different marry status in NYC
marry_plot_data %>%
  group_by(year, new_marry_status) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, color = new_marry_status)) +
  geom_line() +
  geom_point() +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      color = "Marital status") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_color_viridis(discrete = TRUE)

#the birth trend in different marry status in NYC for each boro
marry_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, color = new_marry_status)) +
  geom_line() +
  geom_point() +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      color = "Marital status") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "bottom")
```

infant sex

```{r}
# data for infant sex
infant_sex_plot_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, sex1tot:sex2tot) %>%
  gather(infant_sex, num, sex1tot:sex2tot) %>%
  arrange(cd, infant_sex, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_infant_sex = ifelse(infant_sex == "sex1tot", "Male", "Female")) %>% 
  group_by(year, borough, new_infant_sex) %>% 
  summarise(number = sum(num))  

#the birth trend in different sex in NYC
infant_sex_plot_data %>%
  group_by(year, new_infant_sex) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, fill = new_infant_sex)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      fill = "Infant Sex") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_fill_viridis(discrete = TRUE)

# # of male is always larger
#the birth trend in different sex in NYC for each boro
infant_sex_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, color = new_infant_sex)) +
  geom_line() +
  geom_point() +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      color = "Marital status") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "bottom")
```

plot for bwt

```{r}
birth_weight_plot_data =
  birth_data_un %>% 
  select(year, cd, cd_name, borough, birthtot, bwt1tot:bwt9tot) %>%
  gather(birth_weight, num, bwt1tot:bwt9tot) %>%
  arrange(cd, birth_weight, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  mutate(new_birth_weight = case_when(
    birth_weight %in% c("bwt1tot", "bwt2tot") ~ "< 1000g",
    birth_weight %in% c("bwt3tot", "bwt4tot") ~ "1000g - 1999g",
    birth_weight %in% c("bwt5tot", "bwt6tot") ~ "2000g - 2999g",
    birth_weight %in% c("bwt7tot", "bwt8tot") ~ "3000g - 3999g",
    birth_weight == "bwt9tot" ~ "4000+g"
  )) %>% 
  group_by(year, borough, new_birth_weight) %>% 
  summarise(number = sum(num)) 

#may useful
#the birth trend in different bwt in NYC
birth_weight_plot_data %>%
  group_by(year, new_birth_weight) %>% 
  summarise(number = sum(number)) %>% 
  ggplot(aes(x = year, y = number, color = new_birth_weight)) +
  geom_point() +
  geom_line() +
  labs(title = "",
      y = "Number of  birth",
      x = "Year",
      color = "Infant birthweight") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 1)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "bottom")


#the birth trend in different bwt in NYC for each boro
birth_weight_plot_data %>%
  group_by(year, borough) %>% 
  mutate(percent = number/sum(number)) %>% 
  ggplot(aes(x = year, y = percent, color = new_birth_weight)) +
  geom_point() +
  geom_line() +
  facet_grid( ~ borough) +
  labs(title = "",
      y = "Proportion of number of birth",
      x = "Year",
      color = "Infant birthweight") +
  theme_bw() +
  scale_x_continuous(breaks=seq(2000, 2014, 5)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "bottom")
```

cross 

bwt x age
```{r}
bwt_age_plot_data =
  birth_data_un %>%
  select(year, cd, cd_name, borough, birthtot, contains("ctot_a")) %>%
  select(year, cd, cd_name, borough, birthtot, starts_with("bwt")) %>% 
  gather(bwt_age, num, bwt1ctot_a1:bwt2ctot_a4) %>%
  arrange(cd, bwt_age, year) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num), num)) %>% 
  mutate(num = ifelse(is.na(num) & year != 2000, lag(num, 2), num)) %>% 
  mutate(num = ifelse(is.na(num), 0, num)) %>% 
  separate(bwt_age, c("bwt", "age"), sep = "ctot_") %>%
  mutate(new_bwt = ifelse(bwt == "bwt1", "< 2500g", "2500+g"),
         new_age = case_when(
    age == "a1" ~ "< 20",
    age == "a2" ~ "20 - 20",
    age == "a3" ~ "30 - 39",
    TRUE                      ~  "40 +"
  )) %>% 
  group_by(year, borough, new_bwt, new_age) %>% 
  summarise(number = sum(num))

```

