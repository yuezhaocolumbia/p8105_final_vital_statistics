---
title: "Yx2510 data tidy"
author: "Yi Xiao"
date: "25/11/2018"
output: html_document
---
```{r, message = FALSE}
library(haven)
library(dplyr)
library(tidyverse)
library(stringi)
library(ggplot2)
library(ggmap)
library(rgeos)
library(maptools)
library(geojsonio)
library(viridis)


```

# 1. data import
```{r import data, message = FALSE, warning = FALSE}
#import death data from 2004 to 2014
name = list.files(path = "./data", full.names = TRUE, pattern = "*.sas7bdat") 
cd_data =  map_df(name, read_sas)  %>%
  janitor::clean_names()
year = as.data.frame(rep(2004:2014, each = 59)) 

# add a column "year"
cd_data = cbind(year, cd_data) 
colnames(cd_data)[1] = "year"

# import population data
pop_data2 = read_csv("./data/New_York_City_Population_By_Community_Districts2.csv") %>%
 janitor::clean_names() %>%
  select(borough, cd_number, cd_name, x2000_population, x2010_population)
  
# merge the two datasets
my_data = merge(pop_data2, cd_data, by.x = "cd_name", by.y = "community_district") %>%
  arrange(cd_name, borough, year) 
 
my_tidy_data = my_data %>% # we'll use 2000 year population data for 2000 - 2009, and 2010 year data for 2010 -2014 
  mutate(population = ifelse(year < 2010, my_data$x2000_population, my_data$x2010_population)) %>%
  select(-c(x2000_population, x2010_population)) %>% 
  mutate(cd_name = as.factor(cd_name),
         year = as.factor(year)) %>%
  select(c(cd_name:year, x1:population))

```

The generated dataset consists of `r nrow(my_tidy_data)` observations  and `r ncol(my_tidy_data)` columns. Each observation records information on population and death statistics in one of `r n_distinct(my_tidy_data$cd_name)` community districts in New York City. Variables in the original dataset include sex, age, ethnicity and cause of death and their cross variable with each other. Since we are interested in cause of death in this project, we only kept cause of death and its cross information with other demographic variables. Noteworthily, the presence of a large proportion of NAs could be an issue in later steps.

Cause of death is denoted with c1 to c22, which represent Deaths due to:
1. septicemia,
2. HIV, 
3. malignant neoplasms (cancer),
4. cancer of the colon, rectum, and anus,
5. cancer of the pancreas, 
6. trachea, bronchus, and lung, 
7. cancer of the breast (female), 
8. cancer of the prostate, 
9. diabetes mellitus, 
10. use of or poisoning by psychoactive substance excluding alcohol and tobacco,
11. Alzheimer's disease, 
12. diseases of the heart,
13. essential hypertension and hypertensive renal disease,
14. cerebrovascular diseases, 
15. influenza and pneumonia,
16. chronic lower respiratory diseases, 
17. chronic liver disease and cirrhosis, 
18. Nephritis, Nephrotic Syndrome and Nephrosis, 
19. accident except drug poisoning, 
20. intentional self‐harm (suicide), 
21. assault (homicide), respectively. 
22. others

Race/ethnicity is denoted with 1 to 5, standing for: 
1. Hispanic, 
2. Asian Non‐Hispanic, 
3. White Non‐Hispanic, 
4. Black Non‐Hispanic,
5. others

# 2. tidy the data
```{r split our dataset into several subsets}
# we are first dealing with death infomation without accounting for other demographic characteristics
total_death_data = my_tidy_data %>%
  select(cd_name: x22, population) %>%
  gather(key = "cause_of_death", value = number, x1:x22)

## 以下几个 population的数据还要改..这里是总人口，要改成gender／age／race-specific 人口
# cause of death crossed with gender
gender_death_data = my_tidy_data %>%
   select(cd_name : year, c1male :c22female, population) %>%
   gather (key = "cause_of_death", value = "number", c1male : c22female) 
gender_death_data = gender_death_data %>%
   mutate(gender = ifelse(str_detect(gender_death_data$cause_of_death, "male"), "male", "female")) %>%
   mutate(cause_of_death = str_replace(cause_of_death, cause_of_death, substr(gender_death_data$cause_of_death, 1, 2) ))

# cause of death crossed with age 
age_death_data = my_tidy_data %>%
select(cd_name: year, c1age_1_12months:c22age_85, population) %>%
  gather (key = "cause_of_death", value = "number", c1age_1_12months : c22age_85) 
age_death_data = age_death_data %>% 
  mutate(
    age_group = 
      substr(age_death_data$cause_of_death, str_locate(age_death_data$cause_of_death, "age")[,1] + 4, length(age_death_data$cause_of_death))
    ) %>%
  mutate(cause_of_death = str_replace(cause_of_death, cause_of_death, substr(gender_death_data$cause_of_death, 0, (str_locate(age_death_data$cause_of_death, "age")[,1] -1))))



# cause of death crossed with race 
race_death_data = my_tidy_data %>%
   select(cd_name: year, c11:c225, population) %>%
     gather (key = "cause_of_death", value = "number", c11:c225) 

race_death_data = race_death_data %>% 
  mutate(race = stri_sub(race_death_data$cause_of_death, -1)) %>%
  mutate(
    cause_of_death = 
      str_replace(cause_of_death, cause_of_death, substr(race_death_data$cause_of_death, 1, length(race_death_data$cause_of_death)-3)
                  ))
   
```

# 3. data viasualization 
### 3.1 crude mortality data by borough, community district and year
```{r crude mortality rate}
# 10-year average crude mortality rate in each community district in New York City
cd_death_rate = total_death_data %>%
  group_by(borough, cd_name, year) %>%
  summarise(total_cd_death = sum(number, na.rm = TRUE), population = mean(population), cd_number = mean(as.numeric(cd_number))) %>%
  mutate(motality_rate = total_cd_death/population) %>%
  group_by(cd_name, borough) %>%
  summarise(average_death_rate = mean(motality_rate), cd_number = mean(cd_number)) %>%
  arrange(desc(average_death_rate))


cd_death_rate %>%
   ggplot(aes(x = reorder(cd_name,average_death_rate), y = average_death_rate, fill = borough)) +
   geom_bar(stat = "identity") +
   labs(title = "10-year average crude mortality rate in each community district in New York City",
             x = "Community District",
             y = "Average Motality Rate") +
        theme(axis.text.x = element_text(angle=90, vjust=0.6))
   
  


# 10-year average crude mortality rate in each borough in New York City
borough_death_rate = total_death_data %>%
  group_by(borough, year) %>%
  summarise(total_borough_death = sum(number, na.rm = TRUE), population = sum(population)/22) %>%
  mutate(motality_rate = total_borough_death/population) %>%
  group_by(borough) %>%
  summarise(average_death_rate = mean(motality_rate))

borough_death_rate %>%
   ggplot(aes(x = borough, y = average_death_rate)) +
   geom_bar(stat = "identity",width = .75, fill="tomato2") +
   labs(title = "10-year average crude mortality rate in each borough in New York City",
             x = "Borough",
             y = "Average Motality Rate") +
        theme(axis.text.x = element_text(angle=90, vjust=0.6))


# annual mortality rate in New York City from 2004 to 2010
year_death_rate = total_death_data %>%
  group_by(borough, year) %>%
  summarise(total_borough_death = sum(number, na.rm = TRUE), population = sum(population)/22) %>%
  mutate(motality_rate = total_borough_death/population) 
  

year_death_rate %>%
  ggplot(aes(x = year, y = motality_rate, group = borough, color = borough)) +
  geom_line() + geom_point()

  
```

## 3.2 map: crude mortality data by community district
```{r add map}
URL <- "http://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/nycd/FeatureServer/0/query?where=1=1&outFields=*&outSR=4326&f=geojson"
fil <- "nyc_community_districts.geojson"
if (!file.exists(fil)) download.file(URL, fil)

nyc_districts = geojson_read(fil, what="sp")
# nyc_districts@data =  merge(nyc_districts@data, cd_death_rate, by.x = "BoroCD", by.y = "cd_number")

nyc_districts_map = fortify(nyc_districts, region="BoroCD")

mids = cbind.data.frame(as.data.frame(gCentroid(nyc_districts, byid=TRUE)), 
                         id=nyc_districts$BoroCD)

ny_map = ggplot() %>% + 
         geom_map(data=nyc_districts_map, map=nyc_districts_map,
                    aes(x=long, y=lat, map_id=id),
                    color="#2b2b2b", size=0.15, fill=NA) + 
        geom_text(data=mids, aes(x=x, y=y, label=id), size=2) +
        coord_map() + 
        ggthemes::theme_map()


 nyc_districts@data =  merge(nyc_districts@data, cd_death_rate, by.x = "BoroCD", by.y = "cd_number")

choro = data.frame(district=nyc_districts@data$BoroCD,
                    average_death_rate=nyc_districts@data$average_death_rate)

cd_death_map = nyc_districts_map %>%
ggplot()+
geom_map(map=nyc_districts_map,
                    aes(x=long, y=lat, map_id=id),
                    color="#2b2b2b", size=0.15, fill=NA) +
geom_map(data=choro, map=nyc_districts_map,
                    aes(fill=average_death_rate, map_id=district),
                    color="#2b2b2b", size=0.15) +
scale_fill_viridis(name="Average death rate") + 
coord_map() +
ggthemes::theme_map() +
theme(legend.position=c(0.1,0.5)) +
   labs(title = "average crude mortality rate in each community district in New York City from 2004 to 2014"
            )
cd_death_map

```

## 3. leading cause of death in each borough
```{r}
specific_death_rate = total_death_data %>%
  group_by(borough, year, cause_of_death) %>%
  summarise(cause_specific_death = sum(number, na.rm = TRUE), population = sum(population)) %>%
  mutate(cause_specific_death_rate = cause_specific_death/population) %>%
  group_by(borough, cause_of_death) %>%
  summarise(mean_cs_death_rate = mean(cause_specific_death_rate)) %>%
  arrange(borough, mean_cs_death_rate)
  
  
specific_death_rate %>%
  group_by(borough) %>%
  top_n(n = 10, wt = mean_cs_death_rate) %>%
  ggplot(aes(x = reorder(cause_of_death,mean_cs_death_rate), y = mean_cs_death_rate)) +
  geom_bar(stat = "identity") +
  facet_grid(.~ borough) +
  theme(axis.text.x = element_text(angle=90, vjust=0.6))
  
```


